<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="favicon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <title>lifespan | weekly log</title>
    <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 20px;
    }
    section {
      width: fit-content;
      display: flex;
      gap: 10px;
    }
    .month {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .month > p {
      flex: 1;
      margin: 0;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 12px;
      min-width: 60vw;
    }

    fieldset {
      display: flex;
      gap: 10px;
      border: none;
    }

    textarea {
      outline: none;
      border: none;
      border-bottom: 1px solid lightgray;
      width: 100%;
      resize: none;
    }
    </style>
  </head>
  <body>
    <h2>Weekly log(beta)</h2>

    <section>
      <div class="month">
        <p>January</p>
        <p>February</p>
        <p>March</p>
        <p>April</p>
        <p>May</p>
        <p>June</p>
        <p>July</p>
        <p>August</p>
        <p>September</p>
        <p>October</p>
        <p>November</p>
        <p>December</p>
      </div>
      <form id="weekly-log-form" onsubmit="return false"></form>
    </section>

    <button id="save-button" type="button">Save</button>

    <script>
    const WEEKS_PER_YEAR = 52
    const weeklyLogForm = document.getElementById("weekly-log-form")
    const saveButton = document.getElementById("save-button")
    const STORAGE_KEY = "weekly-log"
    const FIELD_ID_PREFIX = "week-"

    const render = () => {
      const weeklyLogTextareaList = Array.from(
        { length: WEEKS_PER_YEAR },
        (_, i) => {
          return `
            <fieldset>
              <label for="${FIELD_ID_PREFIX}${i + 1}">${i + 1}</label>
              <textarea id="${FIELD_ID_PREFIX}${i + 1}" name="${FIELD_ID_PREFIX}${i + 1}"></textarea>
            </fieldset>
          `
        },
      )

      weeklyLogForm.innerHTML = weeklyLogTextareaList.join("")

      // 保存されているログがあれば復元する
      try {
        const stored = localStorage.getItem(STORAGE_KEY)
        if (!stored) return

        const data = JSON.parse(stored)
        for (let i = 1; i <= WEEKS_PER_YEAR; i++) {
          const textarea = document.getElementById(`${FIELD_ID_PREFIX}${i}`)
          if (textarea && data[`${FIELD_ID_PREFIX}${i}`]) {
            textarea.value = data[`${FIELD_ID_PREFIX}${i}`]
          }
        }
      } catch (e) {
        console.error("failed to load weekly log from storage", e)
      }
    }

    const saveWeeklyLog = () => {
      const data = {}

      for (let i = 1; i <= WEEKS_PER_YEAR; i++) {
        const textarea = document.getElementById(`${FIELD_ID_PREFIX}${i}`)
        if (textarea) {
          data[`${FIELD_ID_PREFIX}${i}`] = textarea.value
        }
      }

      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data))
        // 簡単なフィードバック
        saveButton.textContent = "Saved!"
        setTimeout(() => {
          saveButton.textContent = "Save"
        }, 1000)
      } catch (e) {
        console.error("failed to save weekly log", e)
        alert("保存に失敗しました. ブラウザのストレージ設定をご確認ください。")
      }
    }

    window.onload = () => {
      render()
      if (saveButton) {
        saveButton.addEventListener("click", saveWeeklyLog)
      }
    }
    </script>
  </body>
</html>
